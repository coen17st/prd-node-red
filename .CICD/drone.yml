kind: pipeline
type: docker
name: default

steps:

- name: publish
  image: plugins/docker
  settings:
    username:
      from_secret: docker-registry-username
    password:
      from_secret: docker-registry-password
    registry: docker-registry.theautomation.nl
    repo: docker-registry.theautomation.nl/coen/prd-node-red
    auto_tag: true

- name: deploy
  image: docker
  environment:
    docker_registry_username:
      from_secret: docker-registry-username
    docker_registry_password:
      from_secret: docker-registry-password
  commands:
  - docker login -u $docker_registry_username -p $docker_registry_password https://docker-registry.theautomation.nl
  - sh ./.CICD/deploy.sh
  volumes:
  - name: docker_sock
    path: /var/run/docker.sock

- name: notify
  image: drillster/drone-email
  settings:
    from:
      from_secret: email-address
    host: smtp.gmail.com
    username:
      from_secret: email-address
    password:
      from_secret: email-password
    recipients:
      - c.stam.mail@gmail.com
    subject: >
        [{{ build.status }}]
        {{ repo.owner }}/{{ repo.name }}
        ({{ build.branch }} - {{ truncate build.commit 8 }})
    body:
      https://git.io/vgvPz

volumes:
- name: docker_sock
  host:
    path: /var/run/docker.sock
